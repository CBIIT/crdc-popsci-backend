Indices:
  - index_name: study_demographics
    type: neo4j
    # type mapping for each property of the index
    mapping:
      study_name:
        type: keyword
      study_id:
        type: keyword
      study_short_name:
        type: keyword
      study_description:
        type: keyword
      study_type:
        type: keyword
      study_design:
        type: keyword
      enrollment_beginning_year:
        type: integer
      enrollment_ending_year:
        type: integer
      study_beginning_year:
        type: integer
      study_ending_year:
        type: integer
      biospecimen_collection:
        type: keyword
      study_status:
        type: keyword
      dbgap_accession_id:
        type: keyword
      number_of_participants:
        type: integer
      participant_maximum_age:
        type: integer
      participant_median_age:
        type: integer
      participant_minimum_age:
        type: integer
      participant_mean_age:
        type: integer
      enrollment_period:
        type: keyword
      study_period:
        type: keyword
      participant_age_range:
        type: keyword
      participant_races:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer
      participant_sexes:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer
      participant_ethnicities:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer
      participant_count_by_age:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer

    # Cypher query will be used to retrieve data from Neo4j, and index into Elasticsearch
    cypher_query: "
                
    
        MATCH (study:study)<-[:associated_with]-(participant:participant)

        UNWIND participant.participant_race AS race_raw
        UNWIND split(toLower(race_raw), '|') AS race_group
        WITH trim(race_group) as race_group, count(*) AS race_group_count,study


        WITH collect(DISTINCT {
            group: race_group,
            subjects: race_group_count
        }) AS participant_races,study


        MATCH (study)<-[:associated_with]-(participant:participant)
        UNWIND participant.participant_sex AS sex_raw
        UNWIND split(toLower(sex_raw), '|') AS sex_group
        WITH participant_races, trim(sex_group) as sex_group, count(*) AS sex_group_count
        ,study


        WITH participant_races, collect(DISTINCT {
            group: sex_group,
            subjects: sex_group_count
        }) AS participant_sexes,study 
        MATCH (study)<-[:associated_with]-(participant:participant)
        UNWIND participant.participant_ethnicity AS ethnicity_raw
        UNWIND split(toLower(ethnicity_raw), '|') AS ethnicity_group
        WITH participant_races, participant_sexes, trim(ethnicity_group) as ethnicity_group, count(*) AS ethnicity_group_count
        ,study
          WITH participant_races,participant_sexes,collect(DISTINCT {
            group: ethnicity_group,
            subjects: ethnicity_group_count
        }) AS participant_ethnicities
        ,study


        MATCH (study)<-[:associated_with]-(participant:participant)

        WITH toInteger(participant.age_at_enrollment / 365.25) AS age_in_years,participant_races,participant_sexes,participant_ethnicities
        ,study
        WITH toInteger(floor(age_in_years / 5) * 5) AS age_band_start, count(*) AS participant_count,participant_races, participant_sexes,participant_ethnicities
        ,study
        WITH age_band_start,
          toInteger(age_band_start) + 4 AS age_band_end,
          participant_count,
          participant_races, participant_sexes,participant_ethnicities
          ,study
          
        WITH toString(age_band_start) + ' to ' + toString(age_band_end)  AS age_group_label,participant_count,age_band_start,participant_races, participant_sexes,participant_ethnicities
        ,study
        ORDER BY age_group_label
        MATCH (study)<-[:associated_with]-(participant:participant)
 

        RETURN
        collect(DISTINCT{
                group: age_group_label, 
                subjects: participant_count
          }) as participant_count_by_age,
          participant_races,
          participant_sexes,
          participant_ethnicities,
        study.study_name as study_name,
              study.study_short_name as study_short_name,
              study.study_id as study_id,
              study.study_description as study_description,
              study.study_type as study_type,
              study.study_design as study_design,
              toString(study.enrollment_beginning_year) as enrollment_beginning_year,
              toInteger(study.enrollment_ending_year) as enrollment_ending_year,
              toInteger(study.enrollment_beginning_year) + ' - ' + toInteger(study.enrollment_ending_year)  as enrollment_period,
              study.study_beginning_year as study_beginning_year,
              toInteger(study.study_ending_year) as study_ending_year,
              toInteger(study.study_beginning_year) + ' - ' + COALESCE(study.study_ending_year,'On Going') as study_period,
              study.biospecimen_collection as biospecimen_collection,
              study.study_status as study_status,
              study.dbgap_accession_id as dbgap_accession_id,
              count(distinct(participant)) as number_of_participants,
              toInteger(round(max(participant.age_at_enrollment / 365.25)))  as participant_maximum_age,
              toInteger(round(apoc.agg.median(participant.age_at_enrollment / 365.25)))  as participant_median_age,
              toInteger(round(avg(participant.age_at_enrollment / 365.25))) as participant_mean_age,
              toInteger(round(min(participant.age_at_enrollment / 365.25))) as participant_minimum_age,
              toInteger(round(min(participant.age_at_enrollment / 365.25))) + ' - '   + toInteger(round(max(participant.age_at_enrollment / 365.25))) as participant_age_range
      

      "

  - index_name: study_cancer_counts
    type: neo4j
    # type mapping for each property of the index
    mapping:
      study_id:
        type: keyword
      study_short_name:
        type: keyword
      cancer_diagnosis_disease_morphology_collection:
        type: nested
        properties:
          group:
            type: keyword
          group_code:
            type: keyword
          subjects:
            type: keyword
      cancer_diagnosis_primary_site_collection:
        type: nested
        properties:
          group:
            type: keyword
          group_code:
            type: keyword
          subjects:
            type: keyword
      data_collection_category_count:
        type: integer

    # Cypher query will be used to retrieve data from Neo4j, and index into Elasticsearch
    cypher_query:
       " 
         MATCH (study:study)<-[:associated_with]-(participant:participant)
        with count(participant) as cancer_diagnosis_disease_morphology_count,participant.cancer_diagnosis_disease_morphology as cancer_diagnosis_disease_morphology,participant.`ICD-O-3 Code_disease_morphology` as code_morphology,study
        MATCH (study)<-[:associated_with]-(participant:participant)
        with count(participant) as cancer_diagnosis_primary_site_count,participant.cancer_diagnosis_primary_site as cancer_diagnosis_primary_site,cancer_diagnosis_disease_morphology,cancer_diagnosis_disease_morphology_count,study,code_morphology,participant.`ICD-O-3 Code_primary_site` as code_primary_site
        OPTIONAL MATCH (study)<-[:associated_with]-(data_collection:data_collection)
        RETURN 
            study.study_short_name as study_short_name,
            study.study_id as study_id,

          Collect(Distinct{
            group:cancer_diagnosis_disease_morphology,
            group_code:code_morphology,
            subjects:cancer_diagnosis_disease_morphology_count }) as cancer_diagnosis_disease_morphology_collection,
          Collect(Distinct{
          group:cancer_diagnosis_primary_site,
          group_code:code_primary_site,
          subjects:cancer_diagnosis_primary_site_count }) as cancer_diagnosis_primary_site_collection,
          count(distinct(data_collection.data_collection_category)) as data_collection_category_count
     "
  - index_name: global_stats_bar
    type: neo4j
    # type mapping for each property of the index
    mapping:
      participant_races:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer
      participant_sexes:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer
      participant_ethnicities:
        type: nested
        properties:
          group:
            type: keyword
          subjects:
            type: integer
      study_name:
        type: keyword
      study_short_name:
        type: keyword
      study_id:
        type: keyword
      study_count:
        type: integer
      study_description:
        type: keyword
      study_type:
        type: keyword
      study_design:
        type: keyword
      enrollment_beginning_year:
        type: integer
      enrollment_ending_year:
        type: integer
      enrollment_period:
        type: keyword
      study_beginning_year:
        type: integer
      study_ending_year:
        type: integer
      study_period:
        type: keyword
      biospecimen_collection:
        type: keyword
      study_status:
        type: keyword
      dbgap_accession_id:
        type: keyword
      number_of_participants:
        type: integer
      study_country:
        type: keyword
      study_state_province_territory:
        type: keyword
      cancer_diagnosis_primary_site_count:
        type: integer
      
   # Cypher query will be used to retrieve data from Neo4j, and index into Elasticsearch
    cypher_query:
       " 
          MATCH (study:study)<-[:associated_with]-(participant:participant)
          UNWIND participant.participant_race AS race_raw
          UNWIND split(toLower(race_raw), '|') AS race_group
          WITH trim(race_group) as race_group, count(*) AS race_group_count,study


          WITH collect(DISTINCT {
              group: race_group,
              subjects: race_group_count
          }) AS participant_races,study


          MATCH (study)<-[:associated_with]-(participant)
          UNWIND participant.participant_sex AS sex_raw
          UNWIND split(toLower(sex_raw), '|') AS sex_group
          WITH participant_races, trim(sex_group) as sex_group, count(*) AS sex_group_count
          ,study


          WITH participant_races, collect(DISTINCT {
              group: sex_group,
              subjects: sex_group_count
          }) AS participant_sexes,study
          MATCH (study)<-[:associated_with]-(participant)
          UNWIND participant.participant_ethnicity AS ethnicity_raw
          UNWIND split(toLower(ethnicity_raw), '|') AS ethnicity_group
          WITH participant_races, participant_sexes, trim(ethnicity_group) as ethnicity_group, count(*) AS ethnicity_group_count
          ,study
            WITH participant_races,participant_sexes,collect(DISTINCT {
              group: ethnicity_group,
              subjects: ethnicity_group_count
          }) AS participant_ethnicities
          ,study
          MATCH (study)<-[:associated_with]-(participant)
          optional MATCH (study)<-[:associated_with]-(country:study_country) 
          optional MATCH (study)<-[:associated_with]-(state:study_state_province_territory)
          optional MATCH (study)<-[:associated_with]-(neoplasm:primary_diagnosis)
          
          RETURN
            participant_races,
            participant_sexes,
            participant_ethnicities,
          study.study_name as study_name,
                study.study_short_name as study_short_name,
                study.study_id as study_id,
                count(distinct(study.study_short_name)) as study_count,
                study.study_description as study_description,
                study.study_type as study_type,
                study.study_design as study_design,
                toString(study.enrollment_beginning_year) as enrollment_beginning_year,
                toInteger(study.enrollment_ending_year) as enrollment_ending_year,
                toInteger(study.enrollment_beginning_year) + ' - ' + toInteger(study.enrollment_ending_year)  as enrollment_period,
                study.study_beginning_year as study_beginning_year,
                toInteger(study.study_ending_year) as study_ending_year,
                toInteger(study.study_beginning_year) + ' - ' + COALESCE(study.study_ending_year,'On Going') as study_period,
                study.biospecimen_collection as biospecimen_collection,
                study.study_status as study_status,
                study.dbgap_accession_id as dbgap_accession_id,
                count(distinct(participant)) as number_of_participants,
                Collect(distinct(country.study_country)) as study_country,
                Collect(distinct(state.study_state_province_territory)) as  study_state_province_territory,
                (count(distinct(participant.cancer_diagnosis_primary_site)) - 1) as cancer_diagnosis_primary_site_count
     "
  - index_name: data_volume_query
    type: neo4j
    # type mapping for each property of the index
    mapping:
      study_short_name:
        type: keyword
      study_type:
        type: keyword
      study_design:
        type: keyword
      biospecimen_collection:
        type: keyword
      data_file_uuid:
        type: keyword
      data_volume:
        type: float
      data_file_name:
        type: keyword
      data_file_type:
        type: keyword
      data_file_access_control:
        type: keyword
      data_file_description:
        type: keyword
      data_file_format:
        type: keyword
      number_of_participants:
        type: integer
      data_collection_category:
        type: keyword
      enrollment_beginning_year:
        type: integer
      enrollment_ending_year:
        type: keyword
      study_ending_year:
        type: integer
      study_beginning_year:
        type: integer
      study_status:
        type: keyword
      study_country:
        type: keyword
      study_state_province_territory:
        type: keyword
      study_participant_maximum_age:
        type: float
      study_participant_median_age:
        type: float
      study_participant_minimum_age:
        type: float
      data_file_checksum_value:
        type: keyword
      data_file_compression_status:
        type: keyword
      drs_uri:
        type: keyword
      
    # Cypher query will be used to retrieve data from Neo4j, and index into Elasticsearch
    cypher_query: "
       MATCH (study:study)
      OPTIONAL MATCH (study)<-[:associated_with]-(data:data_file)
      optional MATCH (study)<-[:associated_with]-(neoplasm:primary_diagnosis)
      OPTIONAL MATCH (study)<-[:associated_with]-(data_collection:data_collection)
      WHERE data_collection.data_collection_category_annotation_count <> 0 and data_collection.data_collection_category_annotation_count is not null
      optional MATCH (study)<-[:associated_with]-(study_demo:study_demographic)
      optional MATCH (study)<-[:associated_with]-(country:study_country)
      optional MATCH (study)<-[:associated_with]-(state:study_state_province_territory)

     SET study.study_ending_year = REPLACE(toString(study.study_ending_year), ' ', '')
      SET study.study_ending_year = CASE
      WHEN toLower(trim(toString(study.study_ending_year))) CONTAINS 'ongoing' THEN REPLACE(toLower(trim(toString(study.study_ending_year))),study.study_ending_year, '3000')
      ELSE study.study_ending_year
      END
      RETURN
      study.study_short_name as study_short_name,
      study.study_type as study_type,
      study.study_design as study_design,
      study.biospecimen_collection as biospecimen_collection,
      data.data_file_uuid as data_file_uuid,
      data.data_file_checksum_value as data_file_checksum_value,
      data.data_file_size as data_volume,
      data.data_file_name as data_file_name,
      data.data_file_type as data_file_type,
      data.data_file_access_control as data_file_access_control,
      data.data_file_description as data_file_description,
      data.data_file_format as data_file_format,
      data.data_file_compression_status as data_file_compression_status,
      'drs://nci-crdc.datacommons.io/' + data.data_file_uuid AS drs_uri,
      study.number_of_participants as number_of_participants,
      COLLECT(DISTINCT(data_collection.data_collection_category)) as data_collection_category,
      study.enrollment_beginning_year as enrollment_beginning_year,
      study.enrollment_ending_year as enrollment_ending_year,
      study.study_ending_year as study_ending_year,
      study.study_beginning_year as study_beginning_year,
      study.study_status as study_status,
      Collect(distinct(country.study_country)) as study_country,
      Collect(distinct(state.study_state_province_territory)) as study_state_province_territory,
      study_demo.study_participant_maximum_age as study_participant_maximum_age,
      study_demo.study_participant_median_age as study_participant_median_age,
      study_demo.study_participant_minimum_age as study_participant_minimum_age
      "